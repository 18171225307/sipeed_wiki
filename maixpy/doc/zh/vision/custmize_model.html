<!DOCTYPE html>

<html lang="zh"  class="">


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="keywords" content="">
    
    
    <meta name="description" content="">
    
    <meta name="generator" content="teedoc">
    <meta name="theme" content="teedoc-plugin-theme-default">
    
        
        <meta name="markdown-generator" content="teedoc-plugin-markdown-parser">
        
        <script>
MathJax = {"loader": {"load": ["output/svg"]}, "tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]]}, "svg": {"fontCache": "global"}};
</script>
        
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
        <script src="/maixpy/static/js/theme_default/pre_main.js"></script>
        
        <link rel="stylesheet" href="/maixpy/static/css/theme_default/prism.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/maixpy/static/css/theme_default/viewer.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/maixpy/static/css/theme_default/dark.css" type="text/css"/>
        
        <link rel="stylesheet" href="/maixpy/static/css/theme_default/light.css" type="text/css"/>
        
        <script src="/maixpy/static/js/theme_default/jquery.min.js"></script>
        
        <script src="/maixpy/static/js/theme_default/split.js"></script>
        
        <link rel="stylesheet" href="/maixpy/static/css/search/style.css" type="text/css"/>
        
        <link rel="stylesheet" href="/maixpy/static/css/custom.css" type="text/css"/>
        
    
    
    <title>MaixPy 自定义（离线训练） AI 模型和运行 - MaixPy</title>
    
    <script type="text/javascript">js_vars = {}</script>
    <script type="text/javascript">metadata = {"tags": [], "date": "2024-04-24", "update": [{"date": "2024-4-23", "version": "v1.0", "author": "dragonforward", "content": "加入了YOLOv5s部署"}], "ts": 1713954843, "author": "", "brief": "", "cover": ""}</script>
</head>


<body class="type_doc">
    
    <div id="navbar">
        <div id="navbar_menu">
            <a class="site_title" href="/maixpy/">
                
                
                    <h2>MaixPy</h2>
                
        </a>
            <a id="navbar_menu_btn"></a>
        </div>
        <div id="navbar_items">
            <div>
                <ul id="nav_left">
<li class=""><a  href="https://wiki.sipeed.com">Sipeed Wiki</a></li>
<li class="active"><a  href="/maixpy/doc/zh/index.html">文档</a></li>
<li class=""><a  href="/maixpy/api/index.html">API</a></li>
<li class=""><a  href="/maixpy/doc/zh/faq.html">FAQ</a></li>
</ul>

            </div>
            <div>
                <ul id="nav_right">
<li class=""><a target="_blank" href="https://github.com/sipeed/maixpy"><img src='/maixpy/static/image/github-fill.svg' style='height: 1.5em;vertical-align: middle;'>&nbsp;</a></li>
<li class="sub_items "><a  ><img src='/maixpy/static/image/language.svg' style='height: 1.5em;vertical-align: middle;'>&nbsp;中文</a><ul><li class=""><a  href="/maixpy/doc/en/vision/custmize_model.html">English</a></li>
<li class="active"><a  href="/maixpy/doc/zh/vision/custmize_model.html">中文</a></li>
</ul></li>
</ul>

                <ul class="nav_plugins"><li><a id="themes" class="light"></a></li></ul><ul class="nav_plugins"><li><a id="search"><span class="icon"></span><span class="placeholder">搜索</span>
                            <div id="search_hints">
                                <span id="search_input_hint">输入关键词，多关键词空格隔开</span>
                                <span id="search_loading_hint">正在加载，请稍候。。。</span>
                                <span id="search_download_err_hint">下载文件失败，请刷新重试或检查网络</span>
                                <span id="search_other_docs_result_hint">来自其它文档的结果</span>
                                <span id="search_curr_doc_result_hint">当前文档搜索结果</span>
                            </div></a></li></ul>
            </div>
        </div>
    </div>
    
    <div id="wrapper">
        <div id="sidebar_wrapper">
            <div id="sidebar">
                <div id="sidebar_title">
                    
                </div>
                <ul class="show">
<li class="not_active with_link"><a href="/maixpy/doc/zh/index.html"><span class="label">快速开始</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/faq.html"><span class="label">FAQ 常见问题</span><span class=""></span></a></li>
<li class="not_active no_link sidebar_category"><span class="label">基础</span></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/basic/os.html"><span class="label">升级和烧录系统</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/basic/app_usage.html"><span class="label">应用使用说明</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/basic/maixpy_upgrade.html"><span class="label">更新 MaixPy</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/basic/maixvision.html"><span class="label">MaixVision 使用</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/basic/python.html"><span class="label">Python 语法</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/basic/linux_basic.html"><span class="label">Linux 基础知识</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/basic/python_pkgs.html"><span class="label">添加额外的 Python 包</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/basic/app.html"><span class="label">应用开发和商店</span><span class=""></span></a></li>
<li class="not_active no_link sidebar_category"><span class="label">基础图像和算法</span></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/vision/display.html"><span class="label">屏幕使用</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/vision/camera.html"><span class="label">摄像头使用</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/vision/image_ops.html"><span class="label">基本图像操作</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/vision/find_blobs.html"><span class="label">寻找色块</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/vision/qrcode.html"><span class="label">二维码识别</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/vision/apriltag.html"><span class="label">AprilTag 识别</span><span class=""></span></a></li>
<li class="not_active no_link sidebar_category"><span class="label">AI 视觉</span></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/vision/ai.html"><span class="label">AI 视觉基本知识</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/vision/classify.html"><span class="label">AI 物体分类</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/vision/yolov5.html"><span class="label">YOLOv5 物体检测</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/vision/face_recognition.html"><span class="label">人脸识别</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/vision/body_key_points.html"><span class="label">人体关键点检测</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/vision/self_learn_classifier.html"><span class="label">自学习分类器</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/vision/self_learn_detector.html"><span class="label">自学习检测器</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/vision/object_track.html"><span class="label">物体轨迹跟踪和计数</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/no_translate.html?ref=vision/ocr.html&from=/doc/zh/vision/ocr.html"><span class="label">OCR 文字识别</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/vision/maixhub_train.html"><span class="label">MaixHub 在线 AI 模型训练</span><span class=""></span></a></li>
<li class="active with_link"><a href="/maixpy/doc/zh/vision/custmize_model.html"><span class="label">自定义（离线训练转换）模型</span><span class=""></span></a></li>
<li class="not_active no_link sidebar_category"><span class="label">AI 听觉</span></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/no_translate.html?ref=audio/record.html&from=/doc/zh/audio/record.html"><span class="label">录音</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/no_translate.html?ref=audio/play.html&from=/doc/zh/audio/play.html"><span class="label">播放音频</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/no_translate.html?ref=audio/classifier.html&from=/doc/zh/audio/classifier.html"><span class="label">AI 声音分类器</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/no_translate.html?ref=audio/keyword.html&from=/doc/zh/audio/keyword.html"><span class="label">关键词识别</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/audio/recognize.html"><span class="label">语音实时识别</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/no_translate.html?ref=audio/synthesis.html&from=/doc/zh/audio/synthesis.html"><span class="label">语音合成</span><span class=""></span></a></li>
<li class="not_active no_link sidebar_category"><span class="label">视频</span></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/no_translate.html?ref=video/record.html&from=/doc/zh/video/record.html"><span class="label">录像</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/no_translate.html?ref=video/play.html&from=/doc/zh/video/play.html"><span class="label">播放视频</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/video/jpeg_streaming.html"><span class="label">JPEG 串流</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/no_translate.html?ref=video/rtsp.html&from=/doc/zh/video/rtsp.html"><span class="label">RTSP 串流</span><span class=""></span></a></li>
<li class="not_active no_link sidebar_category"><span class="label">片上外设</span></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/peripheral/gpio.html"><span class="label">GPIO 和 点灯</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/peripheral/uart.html"><span class="label">UART 串口使用</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/peripheral/i2c.html"><span class="label">I2C 使用</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/peripheral/pwm.html"><span class="label">PWM 使用</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/peripheral/spi.html"><span class="label">SPI 使用</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/peripheral/wdt.html"><span class="label">WDT 看门狗使用</span><span class=""></span></a></li>
<li class="not_active no_link sidebar_category"><span class="label">片外模块</span></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/modules/acc.html"><span class="label">加速度计使用</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/no_translate.html?ref=modules/temp_hum.html&from=/doc/zh/modules/temp_hum.html"><span class="label">温湿度传感器</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/modules/tof.html"><span class="label">TOF 测距</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/modules/thermal_cam.html"><span class="label">热成像摄像头</span><span class=""></span></a></li>
<li class="not_active no_link sidebar_category"><span class="label">进阶</span></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/source_code/contribute.html"><span class="label">贡献文档和代码</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/source_code/build.html"><span class="label">构建 MaixPy 源码</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/source_code/faq.html"><span class="label">MaixPy 源码 FAQ</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/source_code/add_c_module.html"><span class="label">使用 C/C++ 写一个模块</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/source_code/maixcdk.html"><span class="label">使用 MaixCDK 开发</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/maixpy/doc/zh/pro/compile_os.html"><span class="label">编译系统</span><span class=""></span></a></li>
</ul>

            </div>
        </div>
        <div id="article">
            <div id="menu_wrapper">
                <div id="menu">
                </div>
            </div>
            <div id="content_wrapper">
                <div id="content_body">
                    <div id="article_head">
                        <div id="article_title">
                            
                            <h1>MaixPy 自定义（离线训练） AI 模型和运行</h1>
                            
                        </div>
                        <div id="article_tags">
                            <ul>
                            
                            </ul>
                        </div>
                        <div id="article_info">
                        <div id="article_info_left">
                            <span class="article_author">
                                
                            </span>
                            
                                <span class="article_date" title="最后修改日期： 2024-04-24">
                                    2024-04-24
                                </span>
                            
                        </div>
                        <div id="article_info_right">
                            
                            <div id="source_link">
                                <a href="https://github.com/sipeed/MaixPy/blob/main/docs/doc/zh/vision/custmize_model.md" target="_blank">
                                    Edit this page
                                </a>
                            </div>
                            
                        </div>
                        </div>
                    </div>
                    <div id="article_tools">
                        <span></span>
                        <span id="toc_btn"></span>
                    </div>
                    <div id="update_history">
                        
                        
                        <details open>
                        
                            <summary>更新历史</summary>
                            <div>
                                <table>
                                        <thead>
                                            <tr>
                                                <th>日期</th>
                                                <th>版本</th>
                                                <th>作者</th>
                                                <th>更新内容</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            
                                                <tr>
                                                    <td>2024-4-23</td>
                                                    <td>v1.0</td>
                                                    <td>dragonforward</td>
                                                    <td>
                                                    
                                                        加入了YOLOv5s部署
                                                    
                                                    </td>
                                                </tr>
                                            
                                        </tbody>
                                </table>
                            </div>
                        </details>
                        
                    </div>
                    <div id="article_content">
                        
                            <blockquote>
<p>本文来自社区用户 dragonforward 的贡献</p>
</blockquote>
<blockquote>
<p>本博客将向你展示零基础一步步的部署好自己的yolov5s模型（博主展示的是安全帽模型），训练就引用我自己之前写过的，已经训练好的可以跳过该部分，其中有部分不一样。</p>
</blockquote>
<h2 id="%E8%8E%B7%E5%BE%97%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%AD%E7%BB%83%E5%BE%97%E5%88%B0%E7%9A%84yolov5s-onnx%E6%A8%A1%E5%9E%8B">获得自定义训练得到的yolov5s onnx模型</h2>
<h3 id="%E5%87%86%E5%A4%87%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E9%9B%86%EF%BC%88%E5%8D%9A%E4%B8%BB%E7%94%A8%E7%9A%84%E6%98%AFVOC%E6%95%B0%E6%8D%AE%E9%9B%86%EF%BC%89">准备自定义数据集（博主用的是VOC数据集）</h3>
<ul>
<li><code>数据集目录结构</code>如下：</li>
</ul>

<pre class="language-none"><code class="language-none">└─VOC2028:		自定义数据集
    ├─Annotations	存放的是数据集标签文件，xml格式
    ├─ImageSets		数据集的划分文件
    │  └─Main
    ├─JPEGImages	存放的是数据集图片
</code></pre>
<ul>
<li><code>分割数据集</code></li>
</ul>
<p>在split_train_val.py文件路径下执行<code>python3 split_train_val.py</code>会得到一下目录结构：</p>

<pre class="language-none"><code class="language-none">└─VOC2028:		自定义数据集
    ├─Annotations	存放的是数据集标签文件，xml格式
    ├─ImageSets		数据集的划分文件
    │  └─Main test.txt
          └─test.txt
          └─train.txt
          └─val.txt
    ├─JPEGImages	存放的是数据集图片
    ├─split_train_val.py	分割数据集的py文件

</code></pre>
<p><code>split_train_val.py文件代码如下</code>：</p>

<pre class="language-none"><code class="language-none"># -*- coding: utf-8 -*-
&quot;&quot;&quot;
Author:dragonforward
简介：分训练集、验证集和测试集，按照 8：1：1 的比例来分，训练集8，验证集1，测试集1
&quot;&quot;&quot;
import os
import random
import argparse

parser = argparse.ArgumentParser()
# xml文件的地址，根据自己的数据进行修改 xml一般存放在Annotations下
parser.add_argument('--xml_path', default='Annotations/', type=str, help='input xml label path')
# 数据集的划分，地址选择自己数据下的ImageSets/Main
parser.add_argument('--txt_path', default='ImageSets/Main/', type=str, help='output txt label path')
opt = parser.parse_args()

train_percent = 0.8  # 训练集所占比例
val_percent = 0.1    # 验证集所占比例
test_persent = 0.1   # 测试集所占比例

xmlfilepath = opt.xml_path
txtsavepath = opt.txt_path
total_xml = os.listdir(xmlfilepath)

if not os.path.exists(txtsavepath):
    os.makedirs(txtsavepath)

num = len(total_xml)  
list = list(range(num))

t_train = int(num * train_percent)  
t_val = int(num * val_percent)

train = random.sample(list, t_train)
num1 = len(train)
for i in range(num1):
    list.remove(train[i])


val_test = [i for i in list if not i in train]
val = random.sample(val_test, t_val)
num2 = len(val)
for i in range(num2):
    list.remove(val[i])


file_train = open(txtsavepath + '/train.txt', 'w')
file_val = open(txtsavepath + '/val.txt', 'w')
file_test = open(txtsavepath + '/test.txt', 'w')

for i in train:
    name = total_xml[i][:-4] + '\n'
    file_train.write(name)

for i in val:
    name = total_xml[i][:-4] + '\n'
    file_val.write(name)    

for i in list:
    name = total_xml[i][:-4] + '\n'
    file_test.write(name)


file_train.close()
file_val.close()
file_test.close()
</code></pre>
<ul>
<li><code>voc转label得到label文件</code></li>
</ul>
<p>目录结构如下：</p>

<pre class="language-none"><code class="language-none">└─VOC2028:		自定义数据集
    ├─Annotations	存放的是数据集标签文件，xml格式
    ├─ImageSets		数据集的划分文件
    │  └─Main
    ├─JPEGImages	存放的是数据集图片
    └─labels		yolov5将此文件夹当作训练的标注文件夹
└─voc_label.py
</code></pre>
<p><code>voc_label.py文件代码如下</code>：</p>

<pre class="language-none"><code class="language-none"># -*- coding: utf-8 -*-
import xml.etree.ElementTree as ET
import os

sets = ['train', 'val', 'test']  # 如果你的Main文件夹没有test.txt，就删掉'test'
classes = [&quot;hat&quot;, &quot;people&quot;]   # 改成自己的类别，VOC数据集有以下20类别
# classes = [&quot;brickwork&quot;, &quot;coil&quot;,&quot;rebar&quot;]   # 改成自己的类别，VOC数据集有以下20类别
# classes = [&quot;aeroplane&quot;, 'bicycle', 'bird', 'boat', 'bottle', 'bus', 'car', 'cat', 'chair', 'cow', 'diningtable', 'dog',
#            'horse', 'motorbike', 'person', 'pottedplant', 'sheep', 'sofa', 'train', 'tvmonitor']  # class names
# abs_path = os.getcwd() /root/yolov5/data/voc_label.py 
abs_path = '/root/yolov5/data/'

def convert(size, box):
    dw = 1. / (size[0])
    dh = 1. / (size[1])
    x = (box[0] + box[1]) / 2.0 - 1
    y = (box[2] + box[3]) / 2.0 - 1
    w = box[1] - box[0]
    h = box[3] - box[2]
    x = x * dw
    w = w * dw
    y = y * dh
    h = h * dh
    return x, y, w, h


def convert_annotation(image_id):
    in_file = open(abs_path + '/VOC2028/Annotations/%s.xml' % (image_id), encoding='UTF-8')
    out_file = open(abs_path + '/VOC2028/labels/%s.txt' % (image_id), 'w')
    tree = ET.parse(in_file)
    root = tree.getroot()
    size = root.find('size')
    w = int(size.find('width').text)
    h = int(size.find('height').text)
    for obj in root.iter('object'):
        difficult = obj.find('difficult').text
        # difficult = obj.find('Difficult').text
        cls = obj.find('name').text
        if cls not in classes or int(difficult) == 1:
            continue
        cls_id = classes.index(cls)
        xmlbox = obj.find('bndbox')
        b = (float(xmlbox.find('xmin').text), float(xmlbox.find('xmax').text), float(xmlbox.find('ymin').text),
             float(xmlbox.find('ymax').text))
        b1, b2, b3, b4 = b
        # 标注越界修正
        if b2 &gt; w:
            b2 = w
        if b4 &gt; h:
            b4 = h
        b = (b1, b2, b3, b4)
        bb = convert((w, h), b)
        out_file.write(str(cls_id) + &quot; &quot; + &quot; &quot;.join([str(a) for a in bb]) + '\n')


for image_set in sets:
    if not os.path.exists(abs_path + '/VOC2028/labels/'):
        os.makedirs(abs_path + '/VOC2028/labels/')

    image_ids = open(abs_path + '/VOC2028/ImageSets/Main/%s.txt' % (image_set)).read().strip().split()
    list_file = open(abs_path + '/VOC2028/%s.txt' % (image_set), 'w')
    for image_id in image_ids:
        list_file.write(abs_path + '/VOC2028/JPEGImages/%s.jpg\n' % (image_id))  # 要么自己补全路径，只写一半可能会报错
        convert_annotation(image_id)
    list_file.close()


</code></pre>
<p><img src="./assets/custmize_model8.png" alt="picture 0" /></p>
<h3 id="%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B">训练模型</h3>
<ul>
<li>配置环境</li>
</ul>

<pre class="language-none"><code class="language-none">git clone https://github.com/ultralytics/yolov5
cd yolov5
pip install -r requirements.txt
pip install onnx
</code></pre>
<ul>
<li>下载预训练权重（博主尝试了v7.0的和v6.0的pt都可以）</li>
</ul>

<pre class="language-none"><code class="language-none">https://github.com/ultralytics/yolov5/releases/download/v7.0/yolov5s.pt
</code></pre>
<p><img src="./assets/custmize_model11.png" alt="picture 1" /></p>
<ul>
<li>训练（博主使用的是学校的集群进行训练）</li>
</ul>

<pre class="language-none"><code class="language-none">python3 train.py --weights weights/yolov5s.pt --cfg models/yolov5s.yaml --data data/safthat.yaml --epochs 150 --batch-size 16 --multi-scale --device 0 
</code></pre>
<p><img src="./assets/custmize_model9.png" alt="picture 2" /></p>

<pre class="language-none"><code class="language-none">python3 detect.py --source /root/yolov5/data/images/000000.jpg --weights /root/yolov5/runs/train/exp13/weights/best.pt --conf-thres 0.25
</code></pre>
<p><img src="./assets/custmize_model10.png" alt="picture 3" /></p>
<ul>
<li>导出onnx模型，由于学校服务器目前去教学上课去了，他们上完课才能分配我就用电脑本机的conda环境导出</li>
</ul>
<p>下面为啥使用<code>-imgsz 224 320</code>,原因就是比较适配屏幕，加上我尝试640<em>640的，摄像头报错，提示是640</em>480这样，然后我就看到sipeed那个yolov5s是320*224的，我也就和他保持一致吧</p>

<pre class="language-none"><code class="language-none">python export.py --weights yolov5s_hat.pt --include onnx --opset 16 --imgsz 224 320
</code></pre>
<p><img src="./assets/custmize_model5.png" alt="picture 4" /></p>
<p>模型查看通过网址输入netron.app查看三个输出：</p>
<p><img src="./assets/custmize_model2.png" alt="picture 5" /></p>
<p>下面是博主的三个输出</p>

<pre class="language-none"><code class="language-none">onnx::Shape_329
onnx::Shape_384
onnx::Shape_439
</code></pre>
<h2 id="%E6%A8%A1%E5%9E%8B%E8%BD%AC%E5%8C%96%EF%BC%88%E5%85%B3%E9%94%AE%EF%BC%89">模型转化（关键）</h2>
<h3 id="%E5%AE%89%E8%A3%85docker%E7%8E%AF%E5%A2%83%EF%BC%88%E5%B7%B2%E5%AE%89%E8%A3%85%E8%BF%87%E7%9A%84%E5%8F%AF%E4%BB%A5%E8%B7%B3%E8%BF%87%EF%BC%89">安装docker环境（已安装过的可以跳过）</h3>

<pre class="language-none"><code class="language-none">安装docker依赖的基础软件
sudo apt-get update
sudo apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common
添加官方来源
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;
安装 docker
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io
</code></pre>
<h3 id="%E5%BC%80%E5%A7%8B%E9%87%8F%E5%8C%96%E6%A8%A1%E5%9E%8B%E5%AE%9E%E6%93%8D%EF%BC%88%EF%BC%81%EF%BC%81%EF%BC%81%EF%BC%89">开始量化模型实操（！！！）</h3>
<h3 id="%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">准备工作</h3>

<pre class="language-none"><code class="language-none">https://github.com/sophgo/tpu-mlir/releases/tag/v1.7
上面网址下载
tpu-mlir-resource.tar 和 tpu_mlir-1.7-py3-none-any.whl 
</code></pre>
<p><img src="./assets/custmize_model3.png" alt="picture 6" /></p>
<p>为什么拉取最新版，因为我用3.1版本失败了，工具在一直更新，最好保持最新，可以看下面图片我使用3.1版本也试过</p>
<p><img src="./assets/custmize_model7.png" alt="picture 7" /></p>

<pre class="language-none"><code class="language-none">
docker pull sophgo/tpuc_dev:latest

进入容器后将上面的准备的两个文件拷贝到workspace目录

root@3d517bc7f51f:/workspace/model_yolov5s# cd ..
root@3d517bc7f51f:/workspace# ls
model_yolov5s  tpu-mlir-resource  tpu-mlir-resource.tar  tpu_mlir-1.7-py3-none-any.whl
root@3d517bc7f51f:/workspace# 

下面两个二选一，我建议是第二个，离线安装
pip install tpu_mlir[all]或者pip install tpu_mlir-*-py3-none-any.whl[all]
博主是选的第二个
pip install tpu_mlir-1.7-py3-none-any.whl
以及安装它的全部依赖
pip install tpu_mlir-1.7-py3-none-any.whl[all] 
解压
tar -xvf tpu-mlir-resource.tar
修改文件夹名字
mv regression/ tpu-mlir-resource/


mkdir model_yolov5s &amp;&amp; cd model_yolov5s

cp -rf ../tpu_mlir_resource/dataset/COCO2017 .
cp -rf ../tpu_mlir_resource/image .


把之前准备好的图片100张一集一张测试图片和onnx模型传递到如下
root@3d517bc7f51f:/workspace# cd model_yolov5s/
root@3d517bc7f51f:/workspace/model_yolov5s# ls
COCO2017  image  workspace  yolov5n_hat.onnx  yolov5s_hat.onnx
root@3d517bc7f51f:/workspace/model_yolov5s# cd COCO2017/
root@3d517bc7f51f:/workspace/model_yolov5s/COCO2017# ls
000000.jpg  000011.jpg  000022.jpg  000032.jpg  000042.jpg  000053.jpg  000066.jpg  000076.jpg  000086.jpg  000096.jpg
000002.jpg  000012.jpg  000023.jpg  000033.jpg  000043.jpg  000054.jpg  000067.jpg  000077.jpg  000087.jpg  000101.jpg
000003.jpg  000013.jpg  000024.jpg  000034.jpg  000044.jpg  000055.jpg  000068.jpg  000078.jpg  000088.jpg  000102.jpg
000004.jpg  000014.jpg  000025.jpg  000035.jpg  000045.jpg  000058.jpg  000069.jpg  000079.jpg  000089.jpg  000103.jpg
000005.jpg  000015.jpg  000026.jpg  000036.jpg  000046.jpg  000059.jpg  000070.jpg  000080.jpg  000090.jpg  000104.jpg
000006.jpg  000016.jpg  000027.jpg  000037.jpg  000048.jpg  000061.jpg  000071.jpg  000081.jpg  000091.jpg  000105.jpg
000007.jpg  000017.jpg  000028.jpg  000038.jpg  000049.jpg  000062.jpg  000072.jpg  000082.jpg  000092.jpg  000106.jpg
000008.jpg  000019.jpg  000029.jpg  000039.jpg  000050.jpg  000063.jpg  000073.jpg  000083.jpg  000093.jpg  000107.jpg
000009.jpg  000020.jpg  000030.jpg  000040.jpg  000051.jpg  000064.jpg  000074.jpg  000084.jpg  000094.jpg  000108.jpg
000010.jpg  000021.jpg  000031.jpg  000041.jpg  000052.jpg  000065.jpg  000075.jpg  000085.jpg  000095.jpg  000109.jpg
root@3d517bc7f51f:/workspace/model_yolov5s/COCO2017# ls -l | grep &quot;^-&quot; | wc -l
100
root@3d517bc7f51f:/workspace/model_yolov5s/COCO2017# 

ls -l | grep &quot;^-&quot; | wc -l可以查看一下图片多少个，COCO2017文件下的图片博主替换了安全帽的100张图片以及测试图片同样

回到 model_yolov5s
root@3d517bc7f51f:/workspace/model_yolov5s/COCO2017# cd ..
root@3d517bc7f51f:/workspace/model_yolov5s# ls
COCO2017  image  workspace  yolov5n_hat.onnx  yolov5s_hat.onnx
root@3d517bc7f51f:/workspace/model_yolov5s# 

接着
mkdir workspace &amp;&amp; cd workspace
执行下面命令ONNX 转 MLIR（记得output_names换为自己的）
model_transform \
--model_name yolov5s \
--model_def ../yolov5s_hat.onnx \
--input_shapes [[1,3,224,320]] \
--mean 0.0,0.0,0.0 \
--scale 0.0039216,0.0039216,0.0039216 \
--keep_aspect_ratio \
--pixel_format rgb \
--output_names onnx::Shape_329,onnx::Shape_439,onnx::Shape_384 \
--test_input ../image/hat.jpg \
--test_result yolov5s_top_outputs.npz \
--mlir yolov5s.mlir

执行下面命令MLIR 转 INT8 模型，转 INT8 模型前需要跑 calibration, 得到校准表
run_calibration yolov5s.mlir \
--dataset ../COCO2017 \
--input_num 100 \
-o yolov5s_cali_table
接着执行下面
model_deploy \
--mlir yolov5s.mlir \
--quantize INT8 \
--calibration_table yolov5s_cali_table \
--processor cv181x \
--test_input yolov5s_in_f32.npz \
--test_reference yolov5s_top_outputs.npz \
--tolerance 0.85,0.45 \
--model yolov5s_cv181x_int8_sym.cvimodel

最后你会得到如下：
root@3d517bc7f51f:/workspace/model_yolov5s/workspace# ls
_weight_map.csv          yolov5s_cv181x_int8_sym.cvimodel         yolov5s_origin.mlir
build_flag.json          yolov5s_cv181x_int8_sym_final.mlir       yolov5s_top_f32_all_origin_weight.npz
final_opt.onnx           yolov5s_cv181x_int8_sym_tensor_info.txt  yolov5s_top_f32_all_weight.npz
yolov5s.mlir             yolov5s_cv181x_int8_sym_tpu.mlir         yolov5s_top_outputs.npz
yolov5s_cali_table       yolov5s_in_f32.npz                       yolov5s_tpu_addressed_cv181x_int8_sym_weight.npz
yolov5s_cv181x_int8_sym  yolov5s_opt.onnx.prototxt                yolov5s_tpu_addressed_cv181x_int8_sym_weight_fix.npz
root@3d517bc7f51f:/workspace/model_yolov5s/workspace# 
</code></pre>
<p>通过上述步骤，你就可以得到量化后的可以部署到开发板上的模型的<br />
解答：<br />
上面为什么会是cv181x，因为我自己先用了一个实验了一下，然后报错如下：</p>

<pre class="language-none"><code class="language-none">-- [I] load cvimodel from: /root/models/yolov5n.cvimodel
cvimodel built for cv180x CANNOT run on platform cv181x
failed to parse cvimodel

</code></pre>
<h3 id="%E5%AE%9E%E6%9C%BA%E8%BF%90%E8%A1%8C">实机运行</h3>
<ul>
<li><code>yolov5s_hat.mud内容如下</code>如下：</li>
</ul>

<pre class="language-none"><code class="language-none">[basic]
type = cvimodel
model = yolov5s_hat_cv181x_int8_sym.cvimodel

[extra]
model_type = yolov5
input_type = rgb
mean = 0, 0, 0
scale = 0.00392156862745098, 0.00392156862745098, 0.00392156862745098
anchors = 10,13, 16,30, 33,23, 30,61, 62,45, 59,119, 116,90, 156,198, 373,326
labels = hat,person

</code></pre>
<p>运行代码</p>

<pre class="language-none"><code class="language-none">from maix import camera, display, image, nn, app

detector = nn.YOLOv5(model=&quot;/root/models/yolov5s_hat.mud&quot;)
cam = camera.Camera(detector.input_width(), detector.input_height(), detector.input_format())
dis = display.Display()
print(&quot;www&quot;)
print(detector.input_width(),detector.input_height(), detector.input_format())

while not app.need_exit():
    img = cam.read()
    objs = detector.detect(img, conf_th = 0.5, iou_th = 0.45)
    for obj in objs:
        img.draw_rect(obj.x, obj.y, obj.w, obj.h, color = image.COLOR_RED)
        msg = f'{detector.labels[obj.class_id]}: {obj.score:.2f}'
        img.draw_string(obj.x, obj.y, msg, color = image.COLOR_RED)
    dis.show(img)
</code></pre>
<p><img src="./assets/custmize_model4.png" alt="picture 8" /></p>
<p>其中10.84.117.1就是ip地址，将cvmodel和mud上传到<code>/root/models/</code> 路径下</p>
<p><img src="./assets/custmize_model1.png" alt="picture 9" /></p>
<p>打包完成后安装应用然后运行就行，也可以ide运行</p>
<p><img src="./assets/custmize_model6.png" alt="picture 10" /></p>
<p>视频链接：</p>

<pre class="language-none"><code class="language-none">https://www.bilibili.com/video/BV1xz421S7Rx/?spm_id_from=333.999.0.0&amp;vd_source=b1fff0f773136d7d05331087929c7739
</code></pre>
<h2 id="%E6%84%9F%E8%B0%A2">感谢</h2>
<p>感谢<code>谁说现在是冬天呢</code>一些思路</p>

                        
                    </div>
                </div>
                <div id="previous_next">
                    <div id="previous">
                        
                        <a href="/maixpy/doc/zh/vision/maixhub_train.html">
                            <span class="icon"></span>
                            <span class="label">MaixHub 在线 AI 模型训练</span>
                        </a>
                        
                    </div>
                    <div id="next">
                        
                        <a href="/maixpy/doc/zh/no_translate.html?ref=audio/record.html&from=/doc/zh/audio/record.html">
                            <span class="label">录音</span>
                            <span class="icon"></span>
                        </a>
                        
                    </div>
                </div>
                <div id="comments-container"></div>
            </div>
            <div id="toc_wrapper">
                <div id="toc">
                    <div id="toc_content">
                            
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a id="to_top" href="#"></a>
    <div id="doc_footer">
        <div id="footer">
            <div id="footer_top">
                <ul>
<li><a>相关链接</a><ul><li><a target="_blank" href="https://wiki.sipeed.com">Sipeed Wiki</a></li>
<li><a target="_blank" href="https://www.sipeed.com">Sipeed 官网</a></li>
<li><a target="_blank" href="https://maixhub.com/">MaixHub</a></li>
<li><a  href="/maixpy/sitemap.xml">网站地图</a></li>
<li><a target="_blank" href="https://github.com/neutree/teedoc">网站使用 teedoc 生成</a></li>
</ul>
</li>
<li><a>源码</a><ul><li><a target="_blank" href="https://github.com/sipeed/maixpy">MaixPy 源码</a></li>
<li><a target="_blank" href="https://github.com/sipeed/MaixCDK">MaixCDK 源码</a></li>
<li><a target="_blank" href="https://github.com/sipeed/sipeed_wiki">Wiki 源码</a></li>
<li><a target="_blank" href="https://github.com/sipeed">开源项目</a></li>
</ul>
</li>
<li><a>关注我们</a><ul><li><a target="_blank" href="https://twitter.com/SipeedIO">twitter</a></li>
<li><a target="_blank" href="https://sipeed.taobao.com/">淘宝</a></li>
<li><a target="_blank" href="https://www.aliexpress.com/store/911876460">AliExpress</a></li>
<li><a target="_blank" href="https://github.com/sipeed">github</a></li>
<li><a><a>微信公众号</a><img src='/maixpy/static/image/wechat.png'></a>
</li>
</ul>
</li>
<li><a>联系我们</a><ul><li><a>电话: +86 0755-27808509</a>
</li>
<li><a>商业支持: support@sipeed.com</a>
</li>
<li><a>地址: 深圳市宝安区新湖路4008号蘅芳科技办公大厦A座-2101C</a>
</li>
<li><a  href="https://wiki.sipeed.com/join_us.html">加入我们</a></li>
</ul>
</li>
</ul>

            </div>
            <div id="footer_bottom">
                <ul>
<li><a target="_blank" href="https://www.sipeed.com">©2018-2023 深圳矽速科技有限公司</a></li>
<li><a target="_blank" href="https://beian.miit.gov.cn/#/Integrated/index">粤ICP备19015433号</a></li>
</ul>

            </div>
        </div>
    </div>
    
        <script src="/maixpy/teedoc-plugin-markdown-parser/mermaid.min.js"></script>
    
        <script>mermaid.initialize({startOnLoad:true});</script>
    
        <script src="/maixpy/static/js/theme_default/tocbot.min.js"></script>
    
        <script src="/maixpy/static/js/theme_default/main.js"></script>
    
        <script src="/maixpy/static/js/theme_default/viewer.min.js"></script>
    
        <script src="/maixpy/static/css/theme_default/prism.min.js"></script>
    
        <script src="/maixpy/static/js/search/search_main.js"></script>
    
        <script src="/maixpy/static/js/custom.js"></script>
    
</body>

</html>